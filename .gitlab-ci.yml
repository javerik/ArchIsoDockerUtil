image: docker:stable

stages:
  - build
  - deploy

before_script:
  - echo "$DOCKERHUB_PASSWORD" | docker login --password-stdin --username $DOCKERHUB_USER

build:test:
  stage: build
  except:
    - main
  script:
    - docker build --no-cache -t test_atos_builder .
    - docker build --no-cache -t test_atos_pkg_builder -f Dockerfile.pkgbuild .

deploy:
  stage: deploy
  only:
    - main
  script:
    - docker build --no-cache -t ucore/archiso:isobuilder .
    - docker push ucore/archiso:isobuilder
    - docker build --no-cache -t ucore/archiso:pkgbuilder -f Dockerfile.pkgbuild .
    - docker push ucore/archiso:pkgbuilder

